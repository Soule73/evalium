name: Tests

on:
    push:
        branches: [main, develop, feature/**]
    pull_request:
        branches: [main, develop]
    workflow_dispatch:

jobs:
    # Tests PHPUnit (Laravel)
    laravel-tests:
        runs-on: ubuntu-latest

        services:
            mysql:
                image: mysql:8.0
                env:
                    MYSQL_ROOT_PASSWORD: password
                    MYSQL_DATABASE: evalium_test
                ports:
                    - 3306:3306
                options: >-
                    --health-cmd="mysqladmin ping"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=3

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.4'
                  extensions: mbstring, dom, fileinfo, mysql, gd, zip, bcmath
                  coverage: xdebug
                  tools: composer:v2

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'yarn'

            - name: Copy .env
              run: cp .env.example .env

            - name: Install Composer dependencies
              run: composer install --prefer-dist --no-interaction --no-progress --optimize-autoloader

            - name: Install NPM dependencies
              run: yarn install --frozen-lockfile

            - name: Build frontend assets
              run: yarn build

            - name: Generate application key
              run: php artisan key:generate

            - name: Run migrations
              run: php artisan migrate --force
              env:
                  DB_CONNECTION: mysql
                  DB_HOST: 127.0.0.1
                  DB_PORT: 3306
                  DB_DATABASE: evalium_test
                  DB_USERNAME: root
                  DB_PASSWORD: password

            - name: Execute PHPUnit tests
              run: php artisan test --coverage --min=70
              env:
                  DB_CONNECTION: mysql
                  DB_HOST: 127.0.0.1
                  DB_PORT: 3306
                  DB_DATABASE: evalium_test
                  DB_USERNAME: root
                  DB_PASSWORD: password

            - name: Upload PHPUnit coverage
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: phpunit-coverage
                  path: coverage/
                  retention-days: 7

    # Tests Vitest (Frontend unit tests)
    vitest-tests:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'yarn'

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Run Vitest tests
              run: yarn test:unit

            - name: Upload Vitest coverage
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: vitest-coverage
                  path: coverage/
                  retention-days: 7

    # Tests Playwright (E2E) - Disabled temporarily
    # playwright-tests:
    #     To re-enable, uncomment this job and add it back to test-summary needs

    # Job de résumé final
    test-summary:
        runs-on: ubuntu-latest
        needs: [laravel-tests, vitest-tests]
        if: always()

        steps:
            - name: Check test results
              run: |
                  echo "Laravel Tests: ${{ needs.laravel-tests.result }}"
                  echo "Vitest Tests: ${{ needs.vitest-tests.result }}"

                  if [ "${{ needs.laravel-tests.result }}" != "success" ] || \
                     [ "${{ needs.vitest-tests.result }}" != "success" ]; then
                    echo "[FAILED] Some tests failed!"
                    exit 1
                  else
                    echo "[SUCCESS] All tests passed!"
                  fi
