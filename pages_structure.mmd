%%{init: {'flowchart': {'htmlLabels': true, 'nodeSpacing': 70, 'rankSpacing': 80}}}%%
graph LR
    %% Niveau 1 à gauche (colonne pour éviter chevauchement)
    subgraph L1["Niveau 1 : Composants partagés - variant pattern"]
        direction TB
        CL["<div style='width:220px;white-space:normal;text-align:left'>ClassList<br>admin | teacher | student</div>"]
        SL["<div style='width:220px;white-space:normal;text-align:left'>SubjectList<br>admin | teacher | class-assignment</div>"]
        AL["<div style='width:220px;white-space:normal;text-align:left'>AssessmentList<br>admin | teacher</div>"]
        EL["<div style='width:220px;white-space:normal;text-align:left'>EnrollmentList<br>admin</div>"]
        CSL["<div style='width:220px;white-space:normal;text-align:left'>ClassSubjectList<br>admin</div>"]
        BEL["<div style='width:220px;white-space:normal;text-align:left'>BaseEntityList<br>base commune</div>"]
    end

    %% Trait et pages partagées au centre
    subgraph TRAIT["HandlesAssessmentViewing"]
        direction TB
        METHODS["<div style='width:200px;white-space:normal;text-align:center'>show() | review()<br>grade() | saveGrade()</div>"]
    end

    subgraph L2["Niveau 2 : Pages partagées - routeContext"]
        direction TB
        AS["<div style='width:180px;white-space:normal;text-align:left'>Assessments/Show</div>"]
        AR["<div style='width:180px;white-space:normal;text-align:left'>Assessments/Review</div>"]
        AG["<div style='width:180px;white-space:normal;text-align:left'>Assessments/Grade</div>"]
    end

    %% Rôles à droite (stackés)
    subgraph ROLES["Rôles et pages spécifiques"]
        direction TB
        subgraph ADMIN["Admin"]
            A_AI["<div style='width:220px;white-space:normal;text-align:left'>Assessments/Index</div>"]
            A_CI["<div style='width:220px;white-space:normal;text-align:left'>Classes/Index | Create | Edit | Show</div>"]
            A_SI["<div style='width:220px;white-space:normal;text-align:left'>Subjects/Index | Create | Edit | Show</div>"]
            A_MGMT["<div style='width:220px;white-space:normal;text-align:left'>Users | Enrollments | AcademicYears<br>Levels | Roles | ClassSubjects</div>"]
        end
        subgraph TEACHER["Teacher"]
            T_AI["<div style='width:220px;white-space:normal;text-align:left'>Assessments/Index | Create | Edit</div>"]
            T_CI["<div style='width:220px;white-space:normal;text-align:left'>Classes/Index | Show</div>"]
            T_SI["<div style='width:220px;white-space:normal;text-align:left'>Subjects/Index | Show</div>"]
        end
        subgraph STUDENT["Student"]
            S_A["<div style='width:220px;white-space:normal;text-align:left'>Assessments/<br>Index | Show | Take | Work | Results</div>"]
            S_E["<div style='width:220px;white-space:normal;text-align:left'>Enrollment/<br>Show | History | Classmates</div>"]
        end
    end

    %% Commun en haut
    subgraph COMMON["Commun"]
        direction LR
        DASH["<div style='width:240px;white-space:normal;text-align:center'>Dashboard<br>Admin | Teacher | Student</div>"]
        AUTH["<div style='width:180px;white-space:normal;text-align:center'>Auth<br>Login | Profile</div>"]
    end

    %% Connexions niveau 1 -> rôles
    CL --> A_CI
    CL --> T_CI
    SL --> A_SI
    SL --> T_SI
    AL --> AS
    AL --> A_CI
    AL --> T_SI
    EL --> A_CI
    CSL --> A_CI

    %% Contrôleurs vers le trait
    ADMIN -.->|AdminAssessmentController| METHODS
    TEACHER -.->|TeacherAssessmentController| METHODS

    %% Le trait expose le routeContext vers les pages (L2)
    METHODS -->|routeContext| AS
    METHODS -->|routeContext| AR
    METHODS -->|routeContext| AG

    %% Liens visuels communs
    DASH --- AUTH
    DASH --> ADMIN
    DASH --> TEACHER
    DASH --> STUDENT
    AUTH --> A_MGMT
